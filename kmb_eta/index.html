<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
</head>
<body>
  <h3 class="text-center">KMB 到站時間搜尋</h3>

  <div class="container">
    <!--Search field-->
    <div class="my-3">
        <div class="input-group">
            <label for="route_input" class="pt-2">路線：</label>
            <input type="text" class="form-control" id="route_input" placeholder="輸入路線" maxlength="10" style="text-transform: uppercase">
        </div>
    </div>

    <!--Result List-->
    <div>
        <table class="table">
            <thead class="thead-dark">
                <tr>
                    <th style="width: 25%">路線</th>
                    <th>方向</th>
                </tr>
            </thead>
            <tbody id="route_list_tbody">
                <!--generated by script-->
            </tbody>
        </table>
    </div>
</div>

<script>
    //const
    const route_list_link = "https://data.etabus.gov.hk/v1/transport/kmb/route/";
    const route_link = "https://data.etabus.gov.hk/v1/transport/kmb/route/{route}/{direction}/{service_type}";
    const stop_list_link = "https://data.etabus.gov.hk/v1/transport/kmb/stop";
    const stop_link = "https://data.etabus.gov.hk/v1/transport/kmb/stop/{stop_id}";
    const route_stop_list_link = "https://data.etabus.gov.hk/v1/transport/kmb/route-stop";
    const route_stop_link = "https://data.etabus.gov.hk/v1/transport/kmb/route-stop/{route}/{direction}/{service_type}";
    const eta_link = "https://data.etabus.gov.hk/v1/transport/kmb/eta/{stop_id}/{route}/{service_type}";
    const stop_eta_link = "https://data.etabus.gov.hk/v1/transport/kmb/stop-eta/{stop_id}";
    const route_eta_link = "https://data.etabus.gov.hk/v1/transport/kmb/route-eta/{route}/{service_type}";

    let route_list_array = "";

    $(document).ready(function () {
        

        // retrieve route list from API
        $.ajax({
            url: route_list_link,
            success: function (ret) {
                route_list_array = ret.data;
                //console.log(route_list_array);
                show_route_list_from_local();
            }
        });

        // filter table by route input 
        $("#route_input").on("keyup", function (e) {
            // trim the input 
            this.value = this.value.trim();
            let route = this.value.toUpperCase();
            console.log(route);

            // reset the table
            show_route_list_from_local();

            if (route == "") return;

            $("#route_list_tbody > tr > td:first-child").each(function (index, tr) {
                // hide the row if the route does not match the input
                if ($(this).text().indexOf(route) != 0) {
                    $(this).parent().css('display', 'none');
                }
                else {
                    //console.log("match");
                }
            });
        });

        // tr click
        $("#route_list_tbody").on("click", "tr", function () {
            let route = $(this).find(".route").text();
            let bound = $(this).find(".bound").text();
            let service_type = $(this).find(".service_type").text();
            let direction = bound == "I" ? "inbound" : "outbound";
            let link_query = "?route=" + route + "&direction=" + direction + "&service_type=" + service_type;

            window.location.href = "./route.html" + link_query;
        });

        
    });

    // 
    function save_route_list_from_link() {

    }

    function show_route_list_from_local() {
        $("#route_list_tbody").text();
        let tbody_string = "";
        $.each(route_list_array, function (i, value) {
            tbody_string += "<tr>" +
                "<td class='route'>" + value.route + "</td>" +
                "<td>" + value.orig_tc + " --> " + value.dest_tc + "</td>" +
                "<td style='display: none' class='bound'>" + value.bound + "</td>" +
                "<td style='display: none' class='service_type'>" + value.service_type + "</td>" +
                "</tr>";
            //console.log(value.route + " : " + value.orig_tc + " --> " + value.dest_tc);
        });
        $("#route_list_tbody").html(tbody_string);
        if (tbody_string == "") {
            alert("顯示路線列表失敗！");
        }
    }
</script>
    <!--Nav bar-->
    <!--nav class="navbar navbar-expand navbar-fixed-top">
      <div class="container">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="#">主頁</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">路線搜尋</a>
          </li>
        </ul>
      </div>
    </nav-->

      <!--Content-->
      <!--div id="content" class="container">
        <table class="table">
          <thead>
            <tr>
              <th>路線</th>
              <th>方向</th>
            </tr>
          </thead>
          <tbody id="route_tbody">
  
          </tbody>
        </table>
      </div-->

      <!--script>
        const route_link = "https://data.etabus.gov.hk/v1/transport/kmb/route/";
        $.ajax({
          url: route_link,
          success: function(result){
            let data = result.data;
            console.log(data);
            let tbody_text = "";
            $.each(data, function(index, value){
              tbody_text += "<tr><td>" + value.route + "</td><td>" + value.orig_tc + " -> " + value.dest_tc + "</td></tr>";
            });
            $("#route_tbody").html(tbody_text);
          }
        });
      </script-->
</body>
</html>