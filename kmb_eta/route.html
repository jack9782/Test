<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETA</title>
    <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

</head>
<body>
    <h3 class="text-center">KMB 到站時間搜尋</h3>

    <div class="container">

        <!--Result List-->
        <div>
            <table class="table">
                <thead class="thead-dark">
                    <tr>
                        <th style="width: 30%">#</th>
                        <th>巴士站</th>
                    </tr>
                </thead>
                <tbody id="stop_list_tbody">
                    <!--generated by script-->
                </tbody>
            </table>
        </div>

    </div>
    <script>
        // const
        const route_list_link = "https://data.etabus.gov.hk/v1/transport/kmb/route/";
        const route_link = "https://data.etabus.gov.hk/v1/transport/kmb/route/{route}/{direction}/{service_type}";
        const stop_list_link = "https://data.etabus.gov.hk/v1/transport/kmb/stop";
        const stop_link = "https://data.etabus.gov.hk/v1/transport/kmb/stop/{stop_id}";
        const route_stop_list_link = "https://data.etabus.gov.hk/v1/transport/kmb/route-stop";
        const route_stop_link = "https://data.etabus.gov.hk/v1/transport/kmb/route-stop/{route}/{direction}/{service_type}";
        const eta_link = "https://data.etabus.gov.hk/v1/transport/kmb/eta/{stop_id}/{route}/{service_type}";
        const stop_eta_link = "https://data.etabus.gov.hk/v1/transport/kmb/stop-eta/{stop_id}";
        const route_eta_link = "https://data.etabus.gov.hk/v1/transport/kmb/route-eta/{route}/{service_type}";

        let stop_list_all_array = "";
        let stop_list_array = "";
        
        // input parameter
        let route, direction, service_type;

        $(document).ready(function () {
            // store the stop information to local
            $.ajax({
                url: stop_list_link,
                success: function (ret) {
                    stop_list_all_array = ret.data;
                    //console.log(stop_list_all_array);
                }
            });
            
            // parameter validation
            let searchParams = new URLSearchParams(window.location.search);
            if (!(searchParams.has("route") && searchParams.has("direction") && searchParams.has("service_type"))) {
                alert("Invalid Parameters!");
                window.location.href = "./index.html";
                return;
            }

            route = searchParams.get("route");
            direction = searchParams.get("direction");
            service_type = searchParams.get("service_type");

            if (route == "" || direction == "" || service_type == "") {
                alert("Invalid Parameters!");
                window.location.href = "./index.html";
                return;
            }

            let stop_link_search = route_stop_link.replace("{route}", route)
                .replace("{direction}", direction)
                .replace("{service_type}", service_type);

            //console.log(stop_link_search);
            retrieve_stop_list_from_API(stop_link_search);

            // on click of tr, remove all the ETA and show the updated ETA of the selected row
            $("#stop_list_tbody").on("click", "tr", function () {
                console.log(this);
                
                let stop_id = $(this).find(".stop").text();
                let eta_link_search = eta_link
                .replace("{stop_id}", stop_id)
                .replace("{route}", route)
                .replace("{service_type}", service_type);

                $.ajax({
                    url: eta_link_search,
                    success: function (ret) {
                        console.clear();
                        console.log(ret);
                        let data = ret.data;
                        console.log(data);
                        let display_string;
                        let eta_array = [];
                        if (data.length > 0){
                            $.each(data, function(){

                            });
                        }
                        else {
                            alert("No record found for ETA");
                        }
                    }
                });
            });
        });

        function retrieve_stop_list_from_API(url) {
            $.ajax({
                url: url,
                success: function (ret) {
                    stop_list_array = ret.data;
                    show_stop_list_from_local();
                }
            });
        }

        function show_stop_list_from_local() {

            $("#stop_list_tbody").text();
            let tbody_string = "";
            $.each(stop_list_array, function (i, value) {
                let stop_id = value.stop;
                let stop_name;
                // retrieve from stop_name from local variable
                $.each(stop_list_all_array, function(i, v){
                    if (v.stop == stop_id){
                        stop_name = v.name_tc;
                        //console.log();
                    }
                });
                tbody_string += "<tr>" +
                    "<td class='seq'>" + value.seq + "</td>" +
                    "<td class='stop'>" + stop_name + "<div>test</div></td>" +
                    "</tr>";
            });

            $("#stop_list_tbody").html(tbody_string);
            if (tbody_string == "") {
                alert("顯示巴士站列表失敗！");
                window.location.href = "./index.html";
                return;
            }
        }
    </script>
</body>
</html>