<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETA</title>
    <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
    <script src="./scripts.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

</head>
<body>
    <h4 class="text-center" id="title-head">KMB 到站時間搜尋</h4>
    <h3 class="text-center" id="route-title">{route} 往 {destination}</h3>
    <div class="container">

        <!--Result List-->
        <div>
            <table class="table">
                <thead class="thead-dark">
                    <tr>
                        <th style="width: 30%">#</th>
                        <th>巴士站</th>
                    </tr>
                </thead>
                <tbody id="stop_list_tbody">
                    <!--generated by script-->
                </tbody>
            </table>
        </div>

    </div>
    <script>
        // const
        const route_list_link = "https://data.etabus.gov.hk/v1/transport/kmb/route/";
        const route_link = "https://data.etabus.gov.hk/v1/transport/kmb/route/{route}/{direction}/{service_type}";
        const stop_list_link = "https://data.etabus.gov.hk/v1/transport/kmb/stop";
        const stop_link = "https://data.etabus.gov.hk/v1/transport/kmb/stop/{stop_id}";
        const route_stop_list_link = "https://data.etabus.gov.hk/v1/transport/kmb/route-stop";
        const route_stop_link = "https://data.etabus.gov.hk/v1/transport/kmb/route-stop/{route}/{direction}/{service_type}";
        const eta_link = "https://data.etabus.gov.hk/v1/transport/kmb/eta/{stop_id}/{route}/{service_type}";
        const stop_eta_link = "https://data.etabus.gov.hk/v1/transport/kmb/stop-eta/{stop_id}";
        const route_eta_link = "https://data.etabus.gov.hk/v1/transport/kmb/route-eta/{route}/{service_type}";

        let stop_list_all_array = JSON.parse(localStorage.getItem('stop_list'));
        let stop_list_array = "";
        
        // input parameter
        let route, direction, service_type, dir, destination;
        // direction: inbound, outbound
        // dir (short form of direction): I, O

        $(document).ready(function () {
            // store the stop information to local
            if (!stop_list_all_array){
                $.ajax({
                    url: stop_list_link,
                    success: function (ret) {
                        stop_list_all_array = ret.data;
                    }
                });
            }
            
            // parameter validation
            let searchParams = new URLSearchParams(window.location.search);
            if (!(searchParams.has("route") && searchParams.has("direction") && searchParams.has("service_type") && searchParams.has("dest"))) {
                alert("Invalid Parameters!");
                window.location.href = "./index.html";
                return;
            }

            route = searchParams.get("route");
            direction = searchParams.get("direction");
            service_type = searchParams.get("service_type");
            destination = searchParams.get("dest");

            if (route == "" || direction == "" || service_type == ""  || destination == "") {
                alert("Invalid Parameters!");
                window.location.href = "./index.html";
                return;
            }

            dir = direction == "inbound" ? "I" : "O";
            $("#route-title").text($("#route-title").text().replace("{route}", route).replace("{destination}", destination));

            let stop_link_search = route_stop_link.replace("{route}", route)
                .replace("{direction}", direction)
                .replace("{service_type}", service_type);

            retrieve_stop_list_from_API(stop_link_search);

            // on click of tr, remove all the ETA and show the updated ETA of the selected row
            $("#stop_list_tbody").on("click", "tr", function (event) {
                
                let tr_obj = $(this);
                let seq = $(this).find(".seq").text();
                let stop_id = $(this).find(".stop_id").text();
                let eta_link_search = eta_link
                .replace("{stop_id}", stop_id)
                .replace("{route}", route)
                .replace("{service_type}", service_type);
                
                if ($(event.target).is(".star")){
                    star_click(route, dir, service_type, seq, event.target);
                    return;
                }

                clear_all_eta();
                $(this).find(".stop").addClass("font-weight-bold");


                $.ajax({
                    url: eta_link_search,
                    success: function (ret) {
                        let eta_data = ret.data;
                        let eta_count = 0;
                        
                        if (eta_data.length > 0){
                            $.each(eta_data, function(i, data){
                                if (data.dir == dir && data.route == route && data.service_type == service_type && data.seq == seq){
                                    if (!data.eta) return;

                                    let eta_seq = data.eta_seq;
                                    let eta_time = Date.parse(data.eta);
                                    let rmk_tc = data.rmk_tc;
                                    let sysdate = Date.parse(new Date());    
                                    let eta_diff = Math.floor((eta_time - sysdate) / 1000 / 60);   // milliseconds to minutes
                                    if (eta_diff <= 0) eta_diff = "-";

                                    let eta_hours = (new Date(eta_time)).getHours();
                                    eta_hours = String(eta_hours).padStart(2, '0'); 
                                    let eta_minutes = (new Date(eta_time)).getMinutes();
                                    eta_minutes = String(eta_minutes).padStart(2, '0');

                                    let display_string = eta_diff + " 分鐘 (" + eta_hours + ":" + eta_minutes + ")";
                                    if (rmk_tc != ""){
                                        display_string += " (" + rmk_tc + ")";
                                    }

                                    switch (eta_seq){
                                        case 1:
                                            $(tr_obj).find(".eta-1").text(display_string);
                                            break;
                                        case 2:
                                            $(tr_obj).find(".eta-2").text(display_string);
                                            break;
                                        case 3:
                                            $(tr_obj).find(".eta-3").text(display_string);
                                            break;
                                    }

                                    eta_count++;
                                }
                            });
                        }
                        else {
                            $(tr_obj).find(".eta-1").text("暫時沒有預定班次");
                        }

                        if (eta_count == 0){
                            $(tr_obj).find(".eta-1").text("暫時沒有預定班次");
                        }
                    }
                });
            });

            $("#title-head").on("click", function(){
                window.location.href = "./index.html";
            });
        });

        function retrieve_stop_list_from_API(url) {
            $.ajax({
                url: url,
                success: function (ret) {
                    stop_list_array = ret.data;
                    show_stop_list_from_local();
                }
            });
        }

        function show_stop_list_from_local() {

            $("#stop_list_tbody").text();
            let tbody_string = "";
            $.each(stop_list_array, function (i, value) {
                let stop_id = value.stop;
                let stop_name;
                // retrieve from stop_name from local variable
                $.each(stop_list_all_array, function(i, v){
                    if (v.stop == stop_id){
                        stop_name = v.name_tc;
                    }
                });
                tbody_string += "<tr>" +

                    "<td>"+
                        "<input type='image' class='star mr-2' width='25px' src='./star.png' style='vertical-align: middle'/>" + 
                        "<span class='seq'>" + value.seq + "</span></td>" +
                    "<td class='stop_time'><div class='stop'>" + stop_name + "</div>" +
                    "<div class='eta-1'></div>" +
                    "<div class='eta-2'></div>" +
                    "<div class='eta-3'></div>" +
                    "</td>" +
                    "<td class='stop_id d-none'>" + stop_id + "</td>" +
                    "</tr>";
            });

            $("#stop_list_tbody").html(tbody_string);
            if (tbody_string == "") {
                alert("顯示巴士站列表失敗！");
                window.location.href = "./index.html";
                return;
            }
        }

        function clear_all_eta(){
            $(".stop").removeClass("font-weight-bold");
            $(".eta-1").text("");
            $(".eta-2").text("");
            $(".eta-3").text("");
        }

        function star_click(route, dir, service_type, seq, event_target){
            let src = event_target.src;
            let src_filename = src.split('/').pop();
            console.log(src.split('/').pop());
            if (src_filename == "star.png"){
                event_target.src = "starred.png";
                console.log("change to starred");
                save_star_route_eta_to_local_storage();
            }
            else {
                event_target.src = "star.png";
                console.log("change to un-star");
                remove_star_route_eta_from_local_storage();
            }
        }

    </script>
</body>
</html>