<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ETA</title>
    <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
    <script src="./scripts.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
</head>
<body>
  <h4 class="text-center" id="title-head">KMB 到站時間搜尋</h4>

  <div class="container">
    <div class="my-3">
      <h6>收藏路線：</h6>
      <table class="table">
        <thead>
          <tr>
            <th style="width: 20%">路線</th>
            <th style="width: 60%">方向</th>
            <th>時間</th>
            <th class="d-none">dir</th>
            <th class="d-none">service_type</th>
            <th class="d-none">seq</th>
            <th class="d-none">stop_id</th>
          </tr>
        </thead>
        <tbody id="star_list_tbody">
          <!--generated by script-->
          <tr><td colspan="100%">沒有收藏路線。</td></tr>
        </tbody>
      </table>
    </div>
    <!--Search field-->
    <div class="my-3">
        <div class="input-group">
            <label for="route_input" class="pt-2">路線：</label>
            <input type="text" class="form-control" id="route_input" placeholder="輸入路線" maxlength="10" style="text-transform: uppercase">
        </div>
    </div>

    <!--Result List-->
    <div>
        <table class="table">
            <thead class="thead-dark">
                <tr>
                    <th style="width: 25%">路線</th>
                    <th>方向</th>
                </tr>
            </thead>
            <tbody id="route_list_tbody">
                <!--generated by script-->
            </tbody>
        </table>
    </div>
</div>

<script>
    let route_list_array = "";
    let stop_list_array = "";
    let star_route_count = 0;

    $(document).ready(function () {
        // retrieve route list from API
        $.ajax({
            url: route_list_link,
            success: function (ret) {
                route_list_array = ret.data;
                save_route_list_to_local_storage();
                show_route_list_from_local();
            }
        });

        // retrieve stop list from API
        $.ajax({
            url: stop_list_link,
            success: function (ret) {
                stop_list_array = ret.data;
                save_stop_list_to_local_storage();
            }
        });
        
        show_star_route_list();
        retrieve_star_route_eta();
        
        // filter table by route input 
        $("#route_input").on("keyup", function (e) {
            // trim the input 
            this.value = this.value.trim();
            let route = this.value.toUpperCase();

            // reset the table
            show_route_list_from_local();

            if (route == "") return;

            $("#route_list_tbody > tr > td:first-child").each(function (index, tr) {
                // hide the row if the route does not match the input
                if ($(this).text().indexOf(route) != 0) {
                    $(this).parent().css('display', 'none');
                }
                else {
                    //console.log("match");
                }
            });
        });

        // tr click and go to route details
        $("#route_list_tbody").on("click", "tr", function () {
            let route = $(this).find(".route").text();
            let bound = $(this).find(".bound").text();
            let service_type = $(this).find(".service_type").text();
            let direction = bound == "I" ? "inbound" : "outbound";
            let dest = $(this).find(".dest").text();
            let link_query = "?route=" + route + "&direction=" + direction + "&service_type=" + service_type + "&dest=" + dest;

            window.location.href = "./route.html" + link_query;
        });
    })

    // 
    function save_route_list_to_local_storage() {
      localStorage.setItem("route_list", JSON.stringify(route_list_array));
    }
    function save_stop_list_to_local_storage(){
      localStorage.setItem("stop_list", JSON.stringify(stop_list_array));
    }

    function show_route_list_from_local() {
        $("#route_list_tbody").text();
        let tbody_string = "";
        $.each(route_list_array, function (i, value) {
            tbody_string += "<tr>" +
                "<td class='route'>" + value.route + "</td>" +
                "<td><span class='orig'>" + value.orig_tc + "</span> --> <span class='dest'>" + value.dest_tc + "</span></td>" +
                "<td style='display: none' class='bound'>" + value.bound + "</td>" +
                "<td style='display: none' class='service_type'>" + value.service_type + "</td>" +
                "</tr>";
            //console.log(value.route + " : " + value.orig_tc + " --> " + value.dest_tc);
        });
        $("#route_list_tbody").html(tbody_string);
        if (tbody_string == "") {
            alert("顯示路線列表失敗！");
        }
    }
    /*
    obj = {
            stop_id: stop_id,
            route: route,
            dir: dir,
            service_type: service_type,
            seq: seq
          }
          */
    function show_star_route_list(){
      // retrieve local storage data
      let star_route_list = JSON.parse(localStorage.getItem('star_route'));
      let route_list = JSON.parse(localStorage.getItem('route_list'));
      let stop_list = JSON.parse(localStorage.getItem('stop_list'));
      star_route_count = 0;

      if (star_route_list && route_list && stop_list){
        
      }
      else {
        return;
      }

      if (star_route_list.length > 0 && route_list.length > 0 && stop_list.length > 0){
        $("#star_list_tbody").html("");
        let star_list_html = "";

        $.each(star_route_list, function(i, v){
          let stop_id = v.stop_id;
          let route = v.route;
          let dir = v.dir;
          let service_type = v.service_type;
          let seq = v.seq;
          let stop_name, dest_tc;

          // retrieve destination name
          $.each(route_list, function(i, route_stop) {
            if (route_stop.route == route && route_stop.bound == dir && route_stop.service_type == service_type){
              dest_tc = route_stop.dest_tc;
              return false;
            }
          });

          // retrieve stop name
          $.each(stop_list, function(i, stop){
            if (stop.stop == stop_id){
              stop_name = stop.name_tc;
              return false;
            }
          });
          /*
          <th style="width: 20%">路線</th>
            <th style="width: 60%">方向</th>
            <th>時間</th>
            <th class="d-none">dir</th>
            <th class="d-none">service_type</th>
            <th class="d-none">seq</th>
            <th class="d-none">stop_id</th>
            */
          // display star route list
          let row_string = "<tr>" + 
            "<td class='route'>" + route + "</td>" + 
            "<td><div class='dest'>往 " + dest_tc + "</div>" +
              "<div class='stop_name'>" + stop_name + "</div>" +
            "<td class='eta'>"+
              "<div class='eta-1'></div>" +
              "<div class='eta-2'></div>" +
              "<div class='eta-3'></div>" +
              "</td>" + 
            "<td class='dir d-none'>" + dir + "</td>" +
            "<td class='service_type d-none'>" + service_type + "</td>" +
            "<td class='seq d-none'>" + seq + "</td>" +
            "<td class='stop_id d-none'>" + stop_id + "</td>" +
            "</tr>";
          
          star_list_html += row_string;
          star_route_count++;
        });
        $("#star_list_tbody").html(star_list_html);
      }
    }

    function retrieve_star_route_eta(){
      if (star_route_count > 0){
        $("#star_list_tbody > tr").each(function (index, tr) {
          console.log($(tr));
          // copy from route.html and modified
          let tr_obj = $(tr);
                let route = $(this).find(".route").text();
                let seq = $(this).find(".seq").text();
                let stop_id = $(this).find(".stop_id").text();
                let service_type = $(this).find(".service_type").text();
                let dir = $(this).find(".dir").text();
                let eta_link_search = eta_link
                .replace("{stop_id}", stop_id)
                .replace("{route}", route)
                .replace("{service_type}", service_type);

                console.log (eta_link_search);
                $.ajax({
                    url: eta_link_search,
                    success: function (ret) {
                        let eta_data = ret.data;
                        let eta_count = 0;
                        console.log(eta_data);
                        if (eta_data.length > 0){
                            $.each(eta_data, function(i, data){


                                if (data.dir == dir && data.route == route && data.service_type == service_type && data.seq == seq){
                                    if (!data.eta) return;
                                    console.log("success");
                                    let eta_seq = data.eta_seq;
                                    let eta_time = Date.parse(data.eta);
                                    let rmk_tc = data.rmk_tc;
                                    let sysdate = Date.parse(new Date());    
                                    let eta_diff = Math.floor((eta_time - sysdate) / 1000 / 60);   // milliseconds to minutes
                                    if (eta_diff <= 0) eta_diff = "-";

                                    let eta_hours = (new Date(eta_time)).getHours();
                                    eta_hours = String(eta_hours).padStart(2, '0'); 
                                    let eta_minutes = (new Date(eta_time)).getMinutes();
                                    eta_minutes = String(eta_minutes).padStart(2, '0');

                                    let display_string = eta_diff + " 分鐘 (" + eta_hours + ":" + eta_minutes + ")";
                                    if (rmk_tc != ""){
                                        display_string += " (" + rmk_tc + ")";
                                    }
                                    console.log("hi");
                                    console.log(display_string);
                                    console.log("bye");
                                    

                                    switch (eta_seq){
                                        case 1:
                                            $(tr_obj).find(".eta-1").text(display_string);
                                            break;
                                        case 2:
                                            $(tr_obj).find(".eta-2").text(display_string);
                                            break;
                                        case 3:
                                            $(tr_obj).find(".eta-3").text(display_string);
                                            break;
                                    }

                                    eta_count++;
                                }
                            });
                        }
                        else {
                            $(tr_obj).find(".eta-1").text("暫時沒有預定班次");
                        }

                        if (eta_count == 0){
                            $(tr_obj).find(".eta-1").text("暫時沒有預定班次");
                        }
                    }
                });
        });
      }
    }

</script>

</body>
</html>